<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:,">
    <title>Nexum Database Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: sans-serif; }
        input, textarea { font-family: monospace; }
        .saved { background-color: #22c55e !important; }
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 1.5rem;
        }
        /* Style for the lookup results */
        .lookup-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .game-link {
            transition: background-color 0.2s;
        }
        .lookup-item:hover {
            background-color: #374151; /* gray-700 */
        }
    </style>
</head>
<body class="bg-gray-800 text-white p-8">

    <div class="container mx-auto">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h1 class="text-3xl font-bold">Nexum Database Editor</h1>
                <p class="text-gray-400">Use this page to edit all game metadata. Changes are saved directly to the `gameplex.db` file.</p>
            </div>
            <button onclick="openAddGameModal()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Add New Game</button>
        </div>
        
        <div class="my-6">
             <input type="text" id="search-editor" placeholder="Filter games by title..." class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <div class="flex justify-end mb-4 space-x-2">
            <button onclick="switchView('grid')" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">Grid View</button>
            <button onclick="switchView('list')" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">List View</button>
        </div>

        <div id="editor-grid" class="card-grid"> <!-- Default view -->
            <!-- Game editor cards will be injected here -->
        </div>
    </div>

    <!-- Add Game Modal -->
    <div id="add-game-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-70 flex items-center justify-center p-4" onclick="closeAddGameModal()">
        <div class="bg-gray-900 rounded-lg p-6 w-full max-w-2xl space-y-4" onclick="event.stopPropagation()">
            <h2 class="text-2xl font-bold">Add a New Game Manually</h2>
            <div>
                <label class="text-sm text-gray-400">Title <span class="text-red-500">*</span></label>
                <div class="flex items-center space-x-2">
                    <input type="text" id="add-title" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-md" required>
                    <button onclick="handleLookup(event)" id="lookup-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">Lookup</button>
                </div>
            </div>
            <div>
                <label class="text-sm text-gray-400">Developer</label>
                <input type="text" id="add-developer" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-md">
            </div>
            <div>
                <label class="text-sm text-gray-400">Release Date (YYYY-MM-DD)</label>
                <input type="text" id="add-release-date" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-md">
            </div>
            <div>
                <label class="text-sm text-gray-400">Rating</label>
                <input type="number" step="0.01" id="add-rating" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-md">
            </div>
            <div>
                <label class="text-sm text-gray-400">Description</label>
                <textarea id="add-description" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-sm h-24"></textarea>
            </div>
            <div>
                <label class="text-sm text-gray-400">Executable Path</label>
                <input type="text" id="add-executablePath" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-sm" placeholder="e.g., game.exe or <InstalledGamePath>\game.exe">
            </div>
            <div>
                <label class="text-sm text-gray-400">Launch Arguments</label>
                <input type="text" id="add-launchArgs" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-sm">
            </div>
            <div class="flex justify-end space-x-4 pt-2">
                <button onclick="closeAddGameModal()" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded">Cancel</button>
                <button onclick="handleCreateGame()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Create Game</button>
            </div>
        </div>
    </div>

    <!-- Lookup Results Modal -->
    <div id="lookup-results-modal" class="hidden fixed inset-0 z-[100] bg-black bg-opacity-70 flex items-center justify-center p-4" onclick="closeLookupModal()">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-3xl max-h-[80vh] flex flex-col" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Lookup Results</h2>
                <button onclick="closeLookupModal()" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div id="lookup-results-list" class="overflow-y-auto space-y-2 pr-2">
                <!-- Search results will be injected here -->
            </div>
        </div>
    </div>

    <script>
        const editorGrid = document.getElementById('editor-grid');
        const searchInput = document.getElementById('search-editor');
        let allGamesData = [];
        let currentView = 'grid'; // or 'list'

        function escapeHTML(str) {
            if (str === null || str === undefined) return '';
            return str.toString().replace(/"/g, '&quot;');
        }

        async function fetchEditorGames() {
            try {
                const response = await fetch('/api/editor/games');
                if (!response.ok) throw new Error('Failed to fetch game data for editor.');
                allGamesData = await response.json();
                renderEditor();
            } catch (error) {
                console.error(error);
                editorGrid.innerHTML = `<p class="text-center text-red-400 p-4">${error.message}</p>`;
            }
        }

        function renderEditor() {
            const filter = searchInput.value.toLowerCase();
            const filteredGames = allGamesData.filter(game => game.title.toLowerCase().includes(filter));
            
            if (currentView === 'list') { renderEditorList(filteredGames); }
            else { renderEditorGrid(filteredGames); }

            editorGrid.innerHTML = filteredGames.map(game => {
                const artUrl = game.art_path ? `${game.art_path}` : 'https://placehold.co/300x450/1f2937/FFFFFF?text=No+Image';
                return `
                <div class="bg-gray-900 rounded-lg p-4 flex flex-col space-y-4" id="game-card-${game.id}">
                    <h2 class="text-xl font-bold truncate">${game.title}</h2>
                    <div class="flex space-x-4">
                        <div class="w-1/3 flex-shrink-0">
                            <img id="poster-img-${game.id}" src="${artUrl}?_t=${Date.now()}" class="rounded w-full aspect-[2/3] object-cover" onerror="this.onerror=null;this.src='https://placehold.co/300x450/1f2937/FFFFFF?text=No+Image';">
                            <input type="file" id="poster-input-${game.id}" class="hidden" accept="image/jpeg,image/png,image/webp" onchange="handlePosterUpload(${game.id})">
                            <button onclick="document.getElementById('poster-input-${game.id}').click()" class="mt-2 w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-1 px-3 rounded text-sm transition-colors duration-200">Change Poster</button>
                        </div>
                        <div class="w-2/3 space-y-3">
                            <div>
                                <label class="text-xs text-gray-400">Title</label>
                                <input type="text" id="title-${game.id}" class="w-full bg-gray-700 border border-gray-600 rounded p-1 text-sm" value="${escapeHTML(game.title)}">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400">Developer</label>
                                <input type="text" id="developer-${game.id}" class="w-full bg-gray-700 border border-gray-600 rounded p-1 text-sm" value="${escapeHTML(game.developer)}">
                            </div>
                             <div>
                                <label class="text-xs text-gray-400">Rating</label>
                                <input type="number" step="0.01" id="rating-${game.id}" class="w-full bg-gray-700 border border-gray-600 rounded p-1 text-sm" value="${game.rating || 0.0}">
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">Description</label>
                        <textarea id="desc-${game.id}" class="w-full bg-gray-700 border border-gray-600 rounded p-1 text-xs h-24">${game.description || ''}</textarea>
                    </div>
                     <div>
                        <label class="text-xs text-gray-400">Executable Path</label>
                        <input type="text" id="exe-${game.id}" class="w-full bg-gray-700 border border-gray-600 rounded p-1 text-xs" value="${escapeHTML(game.executable_path)}">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">Launch Arguments</label>
                        <input type="text" id="args-${game.id}" class="w-full bg-gray-700 border border-gray-600 rounded p-1 text-xs" value="${escapeHTML(game.launch_args)}">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">Custom Save Path</label>
                        <input type="text" id="savepath-${game.id}" class="w-full bg-gray-700 border border-gray-600 rounded p-1 text-xs" value="${escapeHTML(game.custom_save_path)}">
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <div>
                            <button onclick="rescanGame(${game.id}, '${game.title.replace(/\\/g, '\\\\').replace(/'/g, "\\'")}')" class="bg-yellow-600 hover:bg-yellow-700 text-black font-bold py-2 px-4 rounded text-sm">Rescan</button>
                            <button onclick="deleteGame(${game.id}, '${game.title.replace(/\\/g, '\\\\').replace(/'/g, "\\'")}')" class="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded text-sm ml-2">Delete</button>
                        </div>
                        <button onclick="saveGameDetails(${game.id})" class="save-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded text-sm">Save Details</button>
                    </div>
                </div>
                `;
            }).join('');
        }

                function renderEditorGrid(games) {
            editorGrid.className = 'card-grid';
            editorGrid.innerHTML = games.map(game => {
                const artUrl = game.art_path ? game.art_path : 'https://placehold.co/300x450/1f2937/FFFFFF?text=No+Image';
                const releaseYear = game.release_date ? new Date(game.release_date).getFullYear() : 'N/A';
                return `
                    <div class="bg-gray-900 rounded-lg p-4 flex flex-col space-y-4" id="game-card-${game.id}">
                        <a href="game-details.html?id=${game.id}" class="game-link">
                            <img src="${artUrl}?_t=${Date.now()}" class="rounded w-full aspect-[2/3] object-cover" onerror="this.onerror=null;this.src='https://placehold.co/300x450/1f2937/FFFFFF?text=No+Image';">
                            <h2 class="text-lg font-bold truncate mt-2">${game.title} (${releaseYear})</h2>
                        </a>
                    </div>`;
            }).join('');
        }

        function renderEditorList(games) {
            editorGrid.className = '';  // Reset class to remove 'card-grid'
            editorGrid.innerHTML = `
                <table class="min-w-full bg-gray-900 rounded-lg overflow-hidden">
                    <thead class="bg-gray-800">
                        <tr>
                            <th class="py-2 px-4 text-left text-sm font-bold text-gray-300 uppercase tracking-wider">Title</th>
                            <th class="py-2 px-4 text-left text-sm font-bold text-gray-300 uppercase tracking-wider">Added</th>
                            <th class="py-2 px-4 text-left text-sm font-bold text-gray-300 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-gray-900 divide-y divide-gray-700">
                        ${games.map(game => `
                            <tr>
                                <td class="py-2 px-4">
                                    ${game.title}
                                </td>
                                <td class="py-2 px-4">${new Date(game.created_at).toLocaleDateString()}</td>
                                <td class="py-2 px-4">
                                    <a href="game-details.html?id=${game.id}" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded mr-2">Edit</a>
                                    <button onclick="deleteGame(${game.id}, '${game.title.replace(/'/g, "\\'")}')" class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function switchView(view) {
            currentView = view;
            renderEditor();
        }

        function openAddGameModal() {
            document.getElementById('add-game-modal').classList.remove('hidden');
        }

        function closeAddGameModal() {
            document.getElementById('add-game-modal').classList.add('hidden');
            // Clear form fields
            document.getElementById('add-title').value = '';
            document.getElementById('add-executablePath').value = '';
            document.getElementById('add-developer').value = '';
            document.getElementById('add-release-date').value = '';
            document.getElementById('add-rating').value = '';
            document.getElementById('add-description').value = '';
            document.getElementById('add-executablePath').value = '';
            document.getElementById('add-launchArgs').value = '';
        }

        async function handleCreateGame() {
            const title = document.getElementById('add-title').value;
            if (!title.trim()) {
                alert('Title is a required field.');
                return;
            }

            const payload = {
                title: title,
                developer: document.getElementById('add-developer').value,
                release_date: document.getElementById('add-release-date').value,
                rating: parseFloat(document.getElementById('add-rating').value) || 0.0,
                description: document.getElementById('add-description').value,
                executablePath: document.getElementById('add-executablePath').value,
                launchArgs: document.getElementById('add-launchArgs').value,
            };

            try {
                const response = await fetch('/api/editor/games', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to create game.');
                }
                showNotification('Game added successfully!', false);
                closeAddGameModal();
                await fetchEditorGames(); // Refresh the grid
            } catch (error) {
                showNotification(`Error: ${error.message}`, true);
            }
        }
        
        // --- NEW LOOKUP FUNCTIONS ---

        function closeLookupModal() {
            document.getElementById('lookup-results-modal').classList.add('hidden');
            document.getElementById('lookup-results-list').innerHTML = ''; // Clear results
        }

        async function handleLookup(event) {
            event.preventDefault(); // Prevent form submission if any
            const titleQuery = document.getElementById('add-title').value;
            if (!titleQuery.trim()) {
                showNotification('Please enter a title to look up.', true);
                return;
            }

            const lookupBtn = document.getElementById('lookup-btn');
            const resultsList = document.getElementById('lookup-results-list');
            
            lookupBtn.textContent = 'Searching...';
            lookupBtn.disabled = true;
            resultsList.innerHTML = '<p class="text-center">Searching for games...</p>';
            document.getElementById('lookup-results-modal').classList.remove('hidden');

            try {
                const response = await fetch(`/api/search/rawg?query=${encodeURIComponent(titleQuery)}`);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Search request failed.');
                }
                const results = await response.json();

                if (results.length === 0) {
                    resultsList.innerHTML = '<p class="text-center">No results found.</p>';
                    return;
                }

                resultsList.innerHTML = '';
                results.forEach(game => {
                    const releaseYear = game.released ? new Date(game.released).getFullYear() : 'N/A';
                    const item = document.createElement('div');
                    item.className = 'lookup-item p-3 rounded-md flex items-center space-x-4';
                    item.onclick = () => selectGameAndFillForm(game.id);
                    
                    const art = game.background_image ? `<img src="${game.background_image}" class="w-16 h-20 object-cover rounded-md flex-shrink-0">` : `<div class="w-16 h-20 bg-gray-700 rounded-md flex-shrink-0"></div>`;
                    
                    item.innerHTML = `
                        ${art}
                        <div>
                            <p class="font-bold text-lg">${game.name}</p>
                            <p class="text-sm text-gray-400">Released: ${releaseYear}</p>
                        </div>
                    `;
                    resultsList.appendChild(item);
                });

            } catch (error) {
                resultsList.innerHTML = `<p class="text-center text-red-400">Error: ${error.message}</p>`;
                console.error('Lookup failed:', error);
            } finally {
                lookupBtn.textContent = 'Lookup';
                lookupBtn.disabled = false;
            }
        }

        async function selectGameAndFillForm(rawgId) {
            showNotification('Fetching details...');
            closeLookupModal();

            try {
                const response = await fetch(`/api/lookup/rawg/${rawgId}`);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to fetch game details.');
                }
                const details = await response.json();

                // Populate the form in the "Add Game" modal
                document.getElementById('add-title').value = details.name || '';
                document.getElementById('add-developer').value = details.developers ? details.developers.map(d => d.name).join(', ') : '';
                document.getElementById('add-release-date').value = details.released || '';
                document.getElementById('add-rating').value = details.rating || '';
                document.getElementById('add-description').value = details.description_raw || '';
                
                showNotification('Details populated!', false);

            } catch (error) {
                showNotification(`Error: ${error.message}`, true);
                console.error('Failed to fill form:', error);
            }
        }

        function showNotification(message, isError = false) {
             const notification = document.createElement('div');
             notification.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-all duration-300 transform translate-y-20 opacity-0 z-[110] ${isError ? 'bg-red-500' : 'bg-green-500'}`;
             notification.textContent = message;
             document.body.appendChild(notification);
             setTimeout(() => { notification.classList.remove('translate-y-20', 'opacity-0');}, 10);
             setTimeout(() => {
                notification.classList.add('translate-y-20', 'opacity-0');
                setTimeout(() => notification.remove(), 500);
             }, 4000);
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', fetchEditorGames);
        searchInput.addEventListener('input', renderEditor);

        async function handlePosterUpload(gameId) {
            const input = document.getElementById(`poster-input-${gameId}`);
            const file = input.files[0];
            if (!file) return;

            showNotification(`Uploading poster for game ${gameId}...`);
            try {
                const response = await fetch(`/api/editor/games/${gameId}/poster`, {
                    method: 'POST',
                    headers: { 'Content-Type': file.type },
                    body: file
                });
                if (!response.ok) throw new Error('Poster upload failed.');
                
                const data = await response.json();
                document.getElementById(`poster-img-${gameId}`).src = data.new_path + `?t=${new Date().getTime()}`;
                showNotification('Poster updated successfully!', false);
            } catch (error) {
                console.error(error);
                showNotification('Error uploading poster.', true);
            }
        }

        async function saveGameDetails(gameId) {
            const card = document.getElementById(`game-card-${gameId}`);
            const saveButton = card.querySelector('.save-btn');

            const dataToSave = {
                title: card.querySelector(`#title-${gameId}`).value,
                developer: card.querySelector(`#developer-${gameId}`).value,
                rating: parseFloat(card.querySelector(`#rating-${gameId}`).value),
                description: card.querySelector(`#desc-${gameId}`).value,
                executablePath: card.querySelector(`#exe-${gameId}`).value,
                launchArgs: card.querySelector(`#args-${gameId}`).value,
                custom_save_path: card.querySelector(`#savepath-${gameId}`).value
            };

            try {
                const response = await fetch(`/api/editor/games/${gameId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSave)
                });
                if (!response.ok) throw new Error('Failed to save data.');

                const gameInData = allGamesData.find(g => g.id === gameId);
                if (gameInData) {
                    Object.assign(gameInData, dataToSave);
                }

                saveButton.textContent = 'Saved!';
                saveButton.classList.add('saved');
                setTimeout(() => {
                    saveButton.textContent = 'Save Details';
                    saveButton.classList.remove('saved');
                }, 2000);
            } catch (error) {
                console.error('Save failed:', error);
                showNotification(`Error: ${error.message}`, true);
            }
        }
        
        async function rescanGame(gameId, currentTitle) {
            const newTitle = prompt("Enter the new title to search for on RAWG:", currentTitle);
            if (!newTitle || newTitle.trim() === '') {
                return; // User cancelled or entered nothing
            }

            showNotification(`Rescanning game ${gameId} with title: "${newTitle}"...`);
            try {
                 const response = await fetch(`/api/editor/games/${gameId}/rescan`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ newTitle })
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Rescan failed on the server.');
                }
                
                showNotification('Rescan successful! Refreshing data...', false);
                await fetchEditorGames();

            } catch(error) {
                console.error('Rescan failed:', error);
                showNotification(`Error: ${error.message}`, true);
            }
        }

        async function deleteGame(gameId, gameTitle) {
            if (!confirm(`Are you sure you want to permanently delete "${gameTitle}" and all of its files? This action cannot be undone.`)) {
                return;
            }
            showNotification(`Deleting ${gameTitle}...`);
            try {
                const response = await fetch(`/api/editor/games/${gameId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to delete game on the server.');
                }

                showNotification(`"${gameTitle}" was deleted successfully!`, false);
                
                const card = document.getElementById(`game-card-${gameId}`);
                if (card) card.remove();
                
                allGamesData = allGamesData.filter(g => g.id !== gameId);

            } catch (error) {
                console.error('Delete failed:', error);
                showNotification(`Error: ${error.message}`, true);
            }
        }
    </script>
</body>
</html>
