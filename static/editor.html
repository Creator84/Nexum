<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:,">
    <title>GamePlex Database Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: sans-serif; }
        input, textarea { font-family: monospace; }
        .saved { background-color: #22c55e !important; }
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 1.5rem;
        }
    </style>
</head>
<body class="bg-gray-800 text-white p-8">

    <div class="container mx-auto">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h1 class="text-3xl font-bold">GamePlex Database Editor</h1>
                <p class="text-gray-400">Use this page to edit all game metadata. Changes are saved directly to the `gameplex.db` file.</p>
            </div>
            <button onclick="openAddGameModal()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Add New Game</button>
        </div>
        
        <div class="my-6">
             <input type="text" id="search-editor" placeholder="Filter games by title..." class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <div id="editor-grid" class="card-grid">
            <!-- Game editor cards will be injected here -->
        </div>
    </div>

    <!-- Add Game Modal -->
    <div id="add-game-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-70 flex items-center justify-center p-4">
        <!-- Modal content -->
    </div>

    <script>
        const editorGrid = document.getElementById('editor-grid');
        const searchInput = document.getElementById('search-editor');
        let allGamesData = [];

        // NOTE: The JavaScript is identical to your original file.
        // No changes were needed here, but I've included it for completeness.
        // The only change is that art paths might need to be prefixed with the server URL
        // if they are not absolute paths. My refactored scanner now creates relative web paths.
        // For example: `/static/gamelibrary/game-folder/artwork/poster.jpg`
        // This should work correctly with the new server setup.

        function escapeHTML(str) {
            if (str === null || str === undefined) return '';
            return str.toString().replace(/"/g, '&quot;');
        }

        async function fetchEditorGames() {
            try {
                const response = await fetch('/api/editor/games');
                if (!response.ok) throw new Error('Failed to fetch game data for editor.');
                allGamesData = await response.json();
                renderEditor();
            } catch (error) {
                console.error(error);
                editorGrid.innerHTML = `<p class="text-center text-red-400 p-4">${error.message}</p>`;
            }
        }

        function renderEditor() {
            const filter = searchInput.value.toLowerCase();
            const filteredGames = allGamesData.filter(game => game.title.toLowerCase().includes(filter));

            editorGrid.innerHTML = filteredGames.map(game => {
                const artUrl = game.art_path ? `${game.art_path}` : 'https://placehold.co/300x450/1f2937/FFFFFF?text=No+Image';
                return `
                <div class="bg-gray-900 rounded-lg p-4 flex flex-col space-y-4" id="game-card-${game.id}">
                    <h2 class="text-xl font-bold truncate">${game.title}</h2>
                    <div class="flex space-x-4">
                        <div class="w-1/3 flex-shrink-0">
                            <img id="poster-img-${game.id}" src="${artUrl}?_t=${Date.now()}" class="rounded w-full aspect-[2/3] object-cover">
                            <input type="file" id="poster-input-${game.id}" class="hidden" accept="image/jpeg,image/png,image/webp" onchange="handlePosterUpload(${game.id})">
                            <button onclick="document.getElementById('poster-input-${game.id}').click()" class="mt-2 w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-1 px-3 rounded text-sm transition-colors duration-200">Change Poster</button>
                        </div>
                        <div class="w-2/3 space-y-3">
                            <div>
                                <label class="text-xs text-gray-400">Title</label>
                                <input type="text" id="title-${game.id}" class="w-full bg-gray-700 border border-gray-600 rounded p-1 text-sm" value="${escapeHTML(game.title)}">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400">Developer</label>
                                <input type="text" id="developer-${game.id}" class="w-full bg-gray-700 border border-gray-600 rounded p-1 text-sm" value="${escapeHTML(game.developer)}">
                            </div>
                             <div>
                                <label class="text-xs text-gray-400">Rating</label>
                                <input type="number" step="0.01" id="rating-${game.id}" class="w-full bg-gray-700 border border-gray-600 rounded p-1 text-sm" value="${game.rating || 0.0}">
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">Description</label>
                        <textarea id="desc-${game.id}" class="w-full bg-gray-700 border border-gray-600 rounded p-1 text-xs h-24">${game.description || ''}</textarea>
                    </div>
                     <div>
                        <label class="text-xs text-gray-400">Executable Path</label>
                        <input type="text" id="exe-${game.id}" class="w-full bg-gray-700 border border-gray-600 rounded p-1 text-xs" value="${escapeHTML(game.executable_path)}">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">Launch Arguments</label>
                        <input type="text" id="args-${game.id}" class="w-full bg-gray-700 border border-gray-600 rounded p-1 text-xs" value="${escapeHTML(game.launch_args)}">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">Custom Save Path</label>
                        <input type="text" id="savepath-${game.id}" class="w-full bg-gray-700 border border-gray-600 rounded p-1 text-xs" value="${escapeHTML(game.custom_save_path)}">
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <div>
                            <button onclick="rescanGame(${game.id}, '${game.title.replace(/\\/g, '\\\\').replace(/'/g, "\\'")}')" class="bg-yellow-600 hover:bg-yellow-700 text-black font-bold py-2 px-4 rounded text-sm">Rescan</button>
                            <button onclick="deleteGame(${game.id}, '${game.title.replace(/\\/g, '\\\\').replace(/'/g, "\\'")}')" class="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded text-sm ml-2">Delete</button>
                        </div>
                        <button onclick="saveGameDetails(${game.id})" class="save-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded text-sm">Save Details</button>
                    </div>
                </div>
                `;
            }).join('');
        }
        
        async function saveGameDetails(gameId) {
            const card = document.getElementById(`game-card-${gameId}`);
            const saveButton = card.querySelector('.save-btn');

            const dataToSave = {
                title: card.querySelector(`#title-${gameId}`).value,
                developer: card.querySelector(`#developer-${gameId}`).value,
                rating: parseFloat(card.querySelector(`#rating-${gameId}`).value),
                description: card.querySelector(`#desc-${gameId}`).value,
                executablePath: card.querySelector(`#exe-${gameId}`).value,
                launchArgs: card.querySelector(`#args-${gameId}`).value,
                custom_save_path: card.querySelector(`#savepath-${gameId}`).value
            };

            try {
                const response = await fetch(`/api/editor/games/${gameId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSave)
                });
                if (!response.ok) throw new Error('Failed to save data.');

                const gameInData = allGamesData.find(g => g.id === gameId);
                if (gameInData) {
                    Object.assign(gameInData, dataToSave);
                }

                saveButton.textContent = 'Saved!';
                saveButton.classList.add('saved');
                setTimeout(() => {
                    saveButton.textContent = 'Save Details';
                    saveButton.classList.remove('saved');
                }, 2000);
            } catch (error) {
                console.error('Save failed:', error);
                alert('Error: Could not save settings to the server.');
            }
        }
        
        async function deleteGame(gameId, gameTitle) {
            if (!confirm(`Are you sure you want to permanently delete "${gameTitle}" and all of its files? This action cannot be undone.`)) {
                return;
            }
            try {
                const response = await fetch(`/api/editor/games/${gameId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to delete game on the server.');
                }
                
                const card = document.getElementById(`game-card-${gameId}`);
                if (card) card.remove();
                
                allGamesData = allGamesData.filter(g => g.id !== gameId);

            } catch (error) {
                console.error('Delete failed:', error);
            }
        }


        // Other functions like openAddGameModal, handleCreateGame, etc. would be here.
        // They are omitted for brevity but are the same as in your original file.

        document.addEventListener('DOMContentLoaded', fetchEditorGames);
        searchInput.addEventListener('input', renderEditor);
    </script>
</body>
</html>
