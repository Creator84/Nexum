<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Details</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: sans-serif; }
        input, textarea { font-family: monospace; }
    </style>
</head>
<body class="bg-gray-800 text-white p-8">
    <div class="container mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold">Game Details</h1>
            <a href="editor.html" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Back to Editor</a>
        </div>

        <div id="game-details" class="bg-gray-900 rounded-lg p-6">
            <!-- Game details will be dynamically loaded here -->
            <p class="text-center text-gray-400">Loading game details...</p>
        </div>
    </div>

    <script>
        const gameDetailsDiv = document.getElementById('game-details');
        const urlParams = new URLSearchParams(window.location.search);
        const gameId = urlParams.get('id');

        async function fetchGameDetails(id) {
            try {
                const response = await fetch(`/api/editor/games/${id}`);
                if (!response.ok) throw new Error('Failed to fetch game details.');
                const game = await response.json();
                renderGameDetails(game);
            } catch (error) {
                console.error(error);
                gameDetailsDiv.innerHTML = `<p class="text-center text-red-400 p-4">${error.message}</p>`;
            }
        }

        function renderGameDetails(game) {
            const artUrl = game.art_path ? game.art_path : 'https://placehold.co/300x450/1f2937/FFFFFF?text=No+Image';
            gameDetailsDiv.innerHTML = `
                <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-6">
                    <div class="w-full md:w-1/3">
                        <img src="${artUrl}?_t=${Date.now()}" class="rounded-lg w-full aspect-[2/3] object-cover" onerror="this.onerror=null;this.src='https://placehold.co/300x450/1f2937/FFFFFF?text=No+Image';">
                    </div>
                    <div class="w-full md:w-2/3 space-y-4">
                        <div>
                            <label class="block text-sm font-bold mb-2">Title</label>
                            <input type="text" id="title" value="${escapeHTML(game.title)}" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-2">Developer</label>
                            <input type="text" id="developer" value="${escapeHTML(game.developer)}" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-2">Release Date</label>
                            <input type="date" id="release_date" value="${game.release_date || ''}" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-2">Rating</label>
                            <input type="number" step="0.01" id="rating" value="${game.rating || 0.0}" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-2">Description</label>
                            <textarea id="description" rows="5" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">${game.description || ''}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-2">Executable Path</label>
                            <input type="text" id="executable_path" value="${escapeHTML(game.executable_path)}" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-2">Launch Arguments</label>
                            <input type="text" id="launch_args" value="${escapeHTML(game.launch_args)}" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                         <div>
                            <label class="block text-sm font-bold mb-2">Custom Save Path</label>
                            <input type="text" id="custom_save_path" value="${escapeHTML(game.custom_save_path)}" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <button onclick="saveGameDetails()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Save Changes</button>
                    </div>
                </div>
            `;
        }

        async function saveGameDetails() {
            const dataToSave = {
                title: document.getElementById('title').value,
                developer: document.getElementById('developer').value,
                release_date: document.getElementById('release_date').value,
                rating: parseFloat(document.getElementById('rating').value),
                description: document.getElementById('description').value,
                executable_path: document.getElementById('executable_path').value,
                launch_args: document.getElementById('launch_args').value,
                custom_save_path: document.getElementById('custom_save_path').value
            };

            try {
                const response = await fetch(`/api/editor/games/${gameId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSave)
                });
                if (!response.ok) throw new Error('Failed to save data.');

                alert('Game details saved successfully!');
            } catch (error) {
                console.error('Save failed:', error);
                alert(`Error: ${error.message}`);
            }
        }

        function escapeHTML(str) {
            if (str === null || str === undefined) return '';
            return str.toString()
                .replace(/"/g, '&quot;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/&/g, '&amp;')
                .replace(/'/g, '&#x27;');
        }

        if (gameId) {
            fetchGameDetails(gameId);
        } else {
            gameDetailsDiv.innerHTML = `<p class="text-center text-red-400 p-4">No game ID provided.</p>`;
        }
    </script>
</body>
</html>
